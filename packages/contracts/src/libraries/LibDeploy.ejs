// SPDX-License-Identifier: MIT

pragma solidity ^0.8.17;

import { console } from "forge-std/console.sol";

// Solecs
import { World } from "@latticexyz/solecs/src/World.sol";
import { Component } from "@latticexyz/solecs/src/Component.sol";
import { getAddressById } from "@latticexyz/solecs/src/utils.sol";
import { IUint256Component } from "@latticexyz/solecs/src/interfaces/IUint256Component.sol";
import { ISystem } from "@latticexyz/solecs/src/interfaces/ISystem.sol";

// Components
<% components.forEach(({name, path}) => { -%>
import { <%= name %>, ID as <%= name %>ID } from "../<%- path ?? '.' %>/<%= name %>.sol";
<% }) -%>

// Systems
<% systems?.forEach(({name, path}) => { -%>
import { <%= name %>, ID as <%= name %>ID } from "../<%- path ?? '.' %>/<%= name %>.sol";
<% }) -%>

// Libraries
<% initLibs?.forEach(initLib => { -%>
import { <%= initLib %> } from "./<%= initLib %>.sol";
<% }) -%>

struct DeployResult {
  World world;
  address deployer;
}

library LibDeploy {

  function deploy(
    address _deployer,
    address _world,
    bool _reuseComponents
  ) internal returns (DeployResult memory result) {
    result.deployer = _deployer;

    // ------------------------
    // Deploy 
    // ------------------------

    // Deploy world
    result.world = _world == address(0) ? new World() : World(_world);
    if(_world == address(0)) result.world.init(); // Init if it's a fresh world

      // Deploy components
    if(!_reuseComponents) {
      address comp;
<% components.forEach(({name}) => { -%>
<% if (withLogs) { -%>
      console.log("Deploying <%= name %>");
<% } -%>
      comp = address(new <%= name %>(address(result.world)));
<% if (withLogs) { -%>
      console.log(comp);
<% } -%>
<% }) -%>
    } 
    
    deploySystems(address(result.world), true);
  }
    
  
  function authorizeWriter(IUint256Component components, uint256 componentId, address writer) internal {
    Component(getAddressById(components, componentId)).authorizeWriter(writer);
  }

  // TODO unify the 2 authorizers?
  function authorizeSysWriter(IUint256Component systems, uint256 systemId, address writer) internal {
    OwnableAndWriteAccess(getAddressById(systems, systemId)).authorizeWriter(writer);
  }
  
  function deploySystems(address _world, bool init) internal {
    World world = World(_world);
    // Deploy systems
    ISystem system; 
    IUint256Component components = world.components();
    IUint256Component systems = world.systems();
<% systems.forEach(system => { -%>
<% if (withLogs) { -%>
    console.log("Deploying <%= system.name %>");
<% } -%>
    // TODO remove the casts when solecslib starts using ISystem
    system = ISystem(address(new <%= system.name %>(world, address(components))));
    world.registerSystem(address(system), <%= system.name %>ID);

<% system.writeAccess?.forEach(component => { -%>
<% if(component === "*") { -%>
<% components.forEach((_component) => { -%>
    authorizeWriter(components, <%= _component.name %>ID, address(system));
<% }) -%>
<% } else { -%>
    authorizeWriter(components, <%= component %>ID, address(system));
<% } -%>
<% }) -%>

<% system.sysWriteAccess?.forEach(_system => { -%>
<% if(_system === "*") { -%>
<% systems.forEach((__system) => { -%>
    authorizeSysWriter(systems, <%= __system.name %>ID, address(system));
<% }) -%>
<% } else { -%>
    authorizeSysWriter(systems, <%= _system %>ID, address(system));
<% } -%>
<% }) -%>

<% if (withLogs) { -%>
    console.log(address(system));
<% } -%>
<% }) -%>

    if (init) {
<% initLibs?.forEach(initLib => { -%>
      <%= initLib %>.initialize(world);
<% }) -%>
    }
  }
}